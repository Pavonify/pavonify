<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private Football Betting Recommendations</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a2f;
      --panel-2: #0f1730;
      --text: #e6ecff;
      --muted: #96a2c7;
      --accent: #52a8ff;
      --green: #39d98a;
      --orange: #ffb020;
      --danger: #ff6b6b;
      --border: rgba(142, 162, 216, 0.2);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #132042 0%, var(--bg) 48%);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      width: min(1200px, 92vw);
      margin: 24px auto 40px;
      display: grid;
      gap: 20px;
    }

    .header {
      background: linear-gradient(140deg, #17264f 0%, #101937 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: var(--shadow);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
    }

    h1 { margin: 0; font-size: clamp(1.1rem, 1.5vw + 0.8rem, 1.8rem); }
    .sub { color: var(--muted); font-size: .92rem; margin-top: 4px; }

    .status-pill {
      font-size: .83rem;
      color: #dbe4ff;
      background: rgba(82, 168, 255, .18);
      border: 1px solid rgba(82, 168, 255, .35);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      align-items: start;
    }

    .panel {
      background: linear-gradient(160deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-head {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .panel-title { margin: 0; font-size: 1.05rem; }
    .panel-note { color: var(--muted); font-size: .86rem; margin: 3px 0 0; }

    .recommendations {
      display: grid;
      gap: 12px;
      padding: 14px;
    }

    .rec-card {
      border: 1px solid var(--border);
      background: rgba(9, 15, 35, 0.78);
      border-radius: 12px;
      padding: 13px;
      display: grid;
      gap: 8px;
    }

    .rec-top {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .league-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px;
    }

    .teams { font-weight: 700; }
    .meta, .reason, .stat-line { color: var(--muted); font-size: .84rem; }
    .market {
      font-size: .8rem;
      background: rgba(82, 168, 255, .18);
      color: #cce6ff;
      border: 1px solid rgba(82, 168, 255, .4);
      border-radius: 999px;
      padding: 6px 10px;
      white-space: nowrap;
    }

    .confidence {
      margin-top: 2px;
      font-weight: 700;
      color: var(--green);
      font-size: .95rem;
    }

    .acca {
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .acca-leg {
      border: 1px solid var(--border);
      background: rgba(7, 12, 28, 0.7);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 4px;
    }

    .acca-footer {
      margin-top: 4px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      display: grid;
      gap: 8px;
    }

    .combined { font-size: 1.08rem; font-weight: 700; }

    button {
      appearance: none;
      border: 1px solid rgba(82, 168, 255, .5);
      color: white;
      background: linear-gradient(180deg, #267cf0 0%, #1b5ab7 100%);
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.08); }

    .error {
      margin: 14px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 107, 107, .4);
      background: rgba(255, 107, 107, .12);
      color: #ffd5d5;
      font-size: .9rem;
    }

    .skeleton {
      border-radius: 12px;
      min-height: 95px;
      background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.13), rgba(255,255,255,.04));
      background-size: 200% 100%;
      animation: pulse 1.2s infinite;
      border: 1px solid rgba(255, 255, 255, 0.07);
    }

    @keyframes pulse {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    .small-muted { color: var(--muted); font-size: .8rem; }

    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <div>
        <h1>Football Betting Intelligence Dashboard</h1>
        <div class="sub">Top recommendations + auto 6-leg accumulator from API-Football v3</div>
      </div>
      <div id="lastUpdated" class="status-pill">Loading fixtures…</div>
    </header>

    <section class="grid">
      <article class="panel">
        <div class="panel-head">
          <div>
            <h2 class="panel-title">Top Recommendations</h2>
            <p class="panel-note">Highest-confidence picks for today + tomorrow</p>
          </div>
          <span class="small-muted" id="fixtureCount">0 matches scored</span>
        </div>
        <div id="recommendations" class="recommendations"></div>
      </article>

      <article class="panel">
        <div class="panel-head">
          <div>
            <h2 class="panel-title">6-Game Accumulator</h2>
            <p class="panel-note">Unique-match legs, confidence blended</p>
          </div>
          <button id="regenBtn" type="button">Regenerate Acca</button>
        </div>
        <div id="acca" class="acca"></div>
      </article>
    </section>
  </main>

  <script>
    const API_BASE = 'https://v3.football.api-sports.io';
    const API_KEY = 'ba26d768516f5ab3062c4d3ec4d61502';
    const HEADERS = {
      'x-apisports-key': API_KEY
    };

    const MAJOR_LEAGUE_IDS = new Set([
      39, 140, 78, 135, 61, 88, 94, 203, 144, 253,
      307, 71, 179, 2, 3, 848, 262, 128, 188, 197,
      119, 106, 113, 103, 98
    ]);

    const recContainer = document.getElementById('recommendations');
    const accaContainer = document.getElementById('acca');
    const fixtureCountEl = document.getElementById('fixtureCount');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const regenBtn = document.getElementById('regenBtn');

    let rankedPicks = [];
    let accaOffset = 0;

    function showSkeletons() {
      recContainer.innerHTML = Array.from({ length: 8 }).map(() => '<div class="skeleton"></div>').join('');
      accaContainer.innerHTML = Array.from({ length: 6 }).map(() => '<div class="skeleton"></div>').join('');
    }

    function dateStr(offset = 0) {
      const d = new Date();
      d.setDate(d.getDate() + offset);
      return d.toISOString().split('T')[0];
    }

    async function fetchJson(path) {
      const response = await fetch(`${API_BASE}${path}`, { headers: HEADERS });
      if (!response.ok) {
        const err = new Error(`API request failed (${response.status})`);
        err.status = response.status;
        throw err;
      }
      return response.json();
    }

    const teamStatsCache = new Map();
    const h2hCache = new Map();

    async function getTeamStats(teamId, leagueId, season) {
      const key = `${teamId}-${leagueId}-${season}`;
      if (teamStatsCache.has(key)) return teamStatsCache.get(key);
      const data = await fetchJson(`/teams/statistics?team=${teamId}&league=${leagueId}&season=${season}`);
      const stats = data.response || null;
      teamStatsCache.set(key, stats);
      return stats;
    }

    async function getH2H(homeId, awayId) {
      const key = `${homeId}-${awayId}`;
      if (h2hCache.has(key)) return h2hCache.get(key);
      const data = await fetchJson(`/fixtures/headtohead?h2h=${homeId}-${awayId}&last=5`);
      const h2h = data.response || [];
      h2hCache.set(key, h2h);
      return h2h;
    }

    function parseForm(form = '') {
      const last5 = form.slice(-5).split('');
      const wins = last5.filter(c => c === 'W').length;
      const draws = last5.filter(c => c === 'D').length;
      const losses = last5.filter(c => c === 'L').length;
      return { wins, draws, losses, games: last5.length || 1 };
    }

    function toNum(v, fallback = 0) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    function safeAvg(obj, path, fallback = 1.2) {
      return toNum(path.reduce((acc, key) => acc && acc[key], obj), fallback);
    }

    function confidenceColor(c) {
      if (c >= 74) return 'var(--green)';
      if (c >= 62) return 'var(--orange)';
      return '#ffd3a4';
    }

    function buildReason(match, market) {
      const { homeForm, awayForm, homeAvgFor, awayAvgFor, homeHomeWins, awayAwayLosses, h2hGoalAvg } = match;
      const homeUnbeaten = homeForm.wins + homeForm.draws;
      if (market === '1X2') {
        return `Home side unbeaten in ${homeUnbeaten}/${homeForm.games} recent games, with opponent losing ${awayAwayLosses} away matches.`;
      }
      if (market === 'Over 2.5 Goals') {
        return `Combined scoring average is ${(homeAvgFor + awayAvgFor).toFixed(2)} goals/game and H2H average is ${h2hGoalAvg.toFixed(2)}.`;
      }
      return `Both teams averaging ${(homeAvgFor).toFixed(2)} and ${(awayAvgFor).toFixed(2)} goals, with ${homeHomeWins} home wins in recent trend.`;
    }

    function scoreFixture(match) {
      const formEdge = ((match.homeForm.wins - match.awayForm.losses) + (match.homeForm.draws * 0.3)) / 5;
      const homeAwayEdge = (match.homeHomeWinRate - match.awayAwayWinRate);
      const goalEdge = (match.homeAvgFor + match.awayAvgFor) - (match.homeAvgAgainst + match.awayAvgAgainst);
      const h2hEdge = (match.h2hHomeWins - match.h2hAwayWins) / 5;

      const weighted =
        (formEdge * 0.34) +
        (homeAwayEdge * 0.28) +
        (goalEdge * 0.22) +
        (h2hEdge * 0.16);

      const expectedGoals = ((match.homeAvgFor + match.awayAvgFor + match.homeAvgAgainst + match.awayAvgAgainst) / 2);
      const bttsLean = (match.homeAvgFor > 1.1 && match.awayAvgFor > 1.0 && match.homeAvgAgainst > 0.8 && match.awayAvgAgainst > 0.8);

      let market = '1X2';
      let marketDetail = `${match.fixture.teams.home.name} to Win`;
      let confidence = 55 + (weighted * 24);

      if (expectedGoals > 2.8 && Math.abs(weighted) < 0.55) {
        market = 'Over 2.5 Goals';
        marketDetail = 'Over 2.5 Goals';
        confidence = 58 + (Math.min(expectedGoals, 3.8) - 2.4) * 12;
      }

      if (bttsLean && expectedGoals > 2.45 && match.h2hGoalAvg > 2.2) {
        market = 'BTTS';
        marketDetail = 'Both Teams To Score';
        confidence = 56 + ((match.homeAvgFor + match.awayAvgFor) / 3.2) * 18;
      }

      confidence = Math.max(50, Math.min(91, confidence));

      return {
        ...match,
        market,
        marketDetail,
        confidence: Number(confidence.toFixed(1)),
        reason: buildReason(match, market)
      };
    }

    async function getFixturesForDates() {
      const [todayData, tomorrowData] = await Promise.all([
        fetchJson(`/fixtures?date=${dateStr(0)}&timezone=UTC`),
        fetchJson(`/fixtures?date=${dateStr(1)}&timezone=UTC`)
      ]);

      return [...(todayData.response || []), ...(tomorrowData.response || [])]
        .filter(f => MAJOR_LEAGUE_IDS.has(f.league.id))
        .sort((a, b) => a.fixture.timestamp - b.fixture.timestamp)
        .slice(0, 52);
    }

    async function enrichFixture(fixture) {
      const leagueId = fixture.league.id;
      const season = fixture.league.season;
      const homeId = fixture.teams.home.id;
      const awayId = fixture.teams.away.id;

      const [homeStats, awayStats, h2h] = await Promise.all([
        getTeamStats(homeId, leagueId, season),
        getTeamStats(awayId, leagueId, season),
        getH2H(homeId, awayId)
      ]);

      const homeForm = parseForm(homeStats?.form || '');
      const awayForm = parseForm(awayStats?.form || '');

      const homeHomePlayed = toNum(homeStats?.fixtures?.played?.home, 1);
      const awayAwayPlayed = toNum(awayStats?.fixtures?.played?.away, 1);

      const h2hHomeWins = h2h.filter(g => g.teams.home.winner && g.teams.home.id === homeId).length;
      const h2hAwayWins = h2h.filter(g => g.teams.away.winner && g.teams.away.id === awayId).length;
      const h2hGoalAvg = h2h.length
        ? h2h.reduce((acc, g) => acc + (toNum(g.goals.home) + toNum(g.goals.away)), 0) / h2h.length
        : 2.2;

      return {
        fixture,
        homeForm,
        awayForm,
        homeHomeWins: toNum(homeStats?.fixtures?.wins?.home),
        awayAwayLosses: toNum(awayStats?.fixtures?.loses?.away),
        homeHomeWinRate: toNum(homeStats?.fixtures?.wins?.home) / homeHomePlayed,
        awayAwayWinRate: toNum(awayStats?.fixtures?.wins?.away) / awayAwayPlayed,
        homeAvgFor: safeAvg(homeStats, ['goals', 'for', 'average', 'total'], 1.2),
        awayAvgFor: safeAvg(awayStats, ['goals', 'for', 'average', 'total'], 1.1),
        homeAvgAgainst: safeAvg(homeStats, ['goals', 'against', 'average', 'total'], 1.0),
        awayAvgAgainst: safeAvg(awayStats, ['goals', 'against', 'average', 'total'], 1.1),
        h2hHomeWins,
        h2hAwayWins,
        h2hGoalAvg
      };
    }

    function renderRecommendations(picks) {
      recContainer.innerHTML = picks.slice(0, 8).map((p, i) => {
        const time = new Date(p.fixture.fixture.date).toLocaleString([], { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        return `
          <div class="rec-card">
            <div class="rec-top">
              <img class="league-logo" src="${p.fixture.league.logo || ''}" alt="${p.fixture.league.name} logo" />
              <div>
                <div class="teams">${i + 1}. ${p.fixture.teams.home.name} vs ${p.fixture.teams.away.name}</div>
                <div class="meta">${p.fixture.league.name} • ${time}</div>
              </div>
              <span class="market">${p.marketDetail}</span>
            </div>
            <div class="confidence" style="color:${confidenceColor(p.confidence)}">Confidence: ${p.confidence}%</div>
            <div class="stat-line">Form: ${p.fixture.teams.home.name} ${p.homeForm.wins}-${p.homeForm.draws}-${p.homeForm.losses} | ${p.fixture.teams.away.name} ${p.awayForm.wins}-${p.awayForm.draws}-${p.awayForm.losses}</div>
            <div class="reason">${p.reason}</div>
          </div>
        `;
      }).join('');
    }

    function buildAccumulator() {
      const used = new Set();
      const legs = [];
      for (let i = accaOffset; i < rankedPicks.length; i++) {
        const p = rankedPicks[i];
        const fixtureId = p.fixture.fixture.id;
        if (used.has(fixtureId)) continue;
        used.add(fixtureId);
        legs.push(p);
        if (legs.length === 6) break;
      }

      if (legs.length < 6) {
        accaContainer.innerHTML = '<div class="error">Not enough unique fixtures to build a full 6-leg accumulator yet.</div>';
        return;
      }

      const combined = legs.reduce((acc, leg) => acc * (leg.confidence / 100), 1) * 100;

      accaContainer.innerHTML = `
        ${legs.map((leg, idx) => `
          <div class="acca-leg">
            <div><strong>Leg ${idx + 1}:</strong> ${leg.fixture.teams.home.name} vs ${leg.fixture.teams.away.name}</div>
            <div class="meta">Pick: ${leg.marketDetail}</div>
            <div class="confidence" style="color:${confidenceColor(leg.confidence)}">${leg.confidence}% confidence</div>
          </div>
        `).join('')}
        <div class="acca-footer">
          <div class="combined">Combined accumulator confidence: ${combined.toFixed(2)}%</div>
          <div class="small-muted">Regenerate shifts to the next confidence tier while keeping one pick per fixture.</div>
        </div>
      `;
    }

    function showError(message) {
      recContainer.innerHTML = `<div class="error">${message}</div>`;
      accaContainer.innerHTML = `<div class="error">${message}</div>`;
      lastUpdatedEl.textContent = 'Unable to refresh data';
    }

    async function loadDashboard() {
      showSkeletons();
      try {
        const fixtures = await getFixturesForDates();

        if (!fixtures.length) {
          showError('No major-league fixtures found for today or tomorrow. Try again later.');
          return;
        }

        const enriched = [];
        for (const fixture of fixtures) {
          try {
            enriched.push(await enrichFixture(fixture));
          } catch (_) {}
        }

        rankedPicks = enriched.map(scoreFixture).sort((a, b) => b.confidence - a.confidence);
        if (!rankedPicks.length) {
          showError('Could not score fixtures from API data. Check API quota and try again.');
          return;
        }

        renderRecommendations(rankedPicks);
        buildAccumulator();

        fixtureCountEl.textContent = `${rankedPicks.length} matches scored`;
        const now = new Date();
        lastUpdatedEl.textContent = `Updated ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} UTC`;

        localStorage.setItem('bettingDashboardCache', JSON.stringify({
          ts: Date.now(),
          picks: rankedPicks.slice(0, 20)
        }));
      } catch (err) {
        if (err.status === 429) {
          showError('API limit reached for now. Please wait and refresh shortly; cached picks are shown when available.');
        } else {
          showError('Network/API issue while fetching fixtures. If offline, cached picks will be loaded.');
        }

        const cache = localStorage.getItem('bettingDashboardCache');
        if (cache) {
          try {
            const parsed = JSON.parse(cache);
            rankedPicks = parsed.picks || [];
            if (rankedPicks.length) {
              renderRecommendations(rankedPicks);
              buildAccumulator();
              fixtureCountEl.textContent = `${rankedPicks.length} cached matches`;
              lastUpdatedEl.textContent = `Offline cache from ${new Date(parsed.ts).toLocaleString()}`;
            }
          } catch (_) {}
        }
      }
    }

    regenBtn.addEventListener('click', () => {
      if (!rankedPicks.length) return;
      accaOffset += 1;
      if (accaOffset > rankedPicks.length - 6) accaOffset = 0;
      buildAccumulator();
    });

    loadDashboard();
  </script>
</body>
</html>
