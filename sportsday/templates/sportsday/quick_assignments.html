{% extends "sportsday/base.html" %}
{% block title %}Sports Day Â· Quick Add/Remove{% endblock %}
{% block content %}
<section class="space-y-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <p class="text-sm uppercase tracking-widest text-slate-400">Quick Add/Remove</p>
            <h1 class="text-2xl font-semibold">Keyboard assignments</h1>
            <p class="text-sm text-slate-400">
                Quickly add or remove students from events with the keyboard.
            </p>
        </div>
        <div class="flex flex-wrap gap-2 text-sm">
            <a href="{% url 'sportsday:events' %}{% if active_meet %}?meet={{ active_meet.slug }}{% endif %}"
               class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-slate-300 hover:border-sky-500/40 hover:text-sky-200">
                Back to events
            </a>
        </div>
    </div>

    {% include "sportsday/partials/quick_assignments_panel.html" %}
</section>

<script>
    (function () {
        const suggestionWidgets = new Map();
        let globalsBound = false;
        let pendingFormReset = false;

        const getHighlightIndex = (container) => {
            const value = container?.dataset?.highlightIndex ?? '-1';
            const parsed = parseInt(value, 10);
            return Number.isNaN(parsed) ? -1 : parsed;
        };

        const setHighlightIndex = (container, index) => {
            if (!container) {
                return;
            }
            container.dataset.highlightIndex = String(index);
        };

        const clearActiveClass = (container) => {
            if (!container) {
                return;
            }
            container.querySelectorAll('.suggestion-option').forEach((option) => {
                option.classList.remove('bg-slate-100');
            });
        };

        const createSuggestionWidget = ({ inputId, containerId, hiddenId, onSelect }) => {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            const hidden = document.getElementById(hiddenId);

            if (!input || !container || !hidden) {
                return null;
            }

            const widget = {
                resetHighlight() {
                    setHighlightIndex(container, -1);
                    clearActiveClass(container);
                },
            };

            setHighlightIndex(container, -1);

            const getOptions = () => Array.from(container.querySelectorAll('.suggestion-option'));

            const moveHighlight = (delta) => {
                const options = getOptions();
                if (!options.length) {
                    widget.resetHighlight();
                    return;
                }
                let index = getHighlightIndex(container);
                index = Number.isNaN(index) ? -1 : index;
                index += delta;
                if (index < 0) {
                    index = options.length - 1;
                } else if (index >= options.length) {
                    index = 0;
                }
                setHighlightIndex(container, index);
                options.forEach((option, optionIndex) => {
                    option.classList.toggle('bg-slate-100', optionIndex === index);
                });
                options[index].scrollIntoView({ block: 'nearest' });
            };

            const selectOption = (option) => {
                if (!option) {
                    return;
                }
                input.value = option.dataset.label || '';
                hidden.value = option.dataset.id || '';
                container.innerHTML = '';
                widget.resetHighlight();
                if (typeof onSelect === 'function') {
                    onSelect();
                }
            };

            input.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    moveHighlight(1);
                    return;
                }
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    moveHighlight(-1);
                    return;
                }
                if (event.key === 'Enter' && !event.shiftKey) {
                    const options = getOptions();
                    const index = getHighlightIndex(container);
                    const option = index >= 0 ? options[index] : null;
                    if (option) {
                        event.preventDefault();
                        selectOption(option);
                    }
                    return;
                }
                widget.resetHighlight();
            });

            input.addEventListener('input', () => {
                widget.resetHighlight();
            });

            container.addEventListener('mousedown', (event) => {
                const option = event.target.closest('.suggestion-option');
                if (!option) {
                    return;
                }
                event.preventDefault();
                selectOption(option);
            });

            suggestionWidgets.set(containerId, widget);
            return widget;
        };

        const initQuickAssignmentUI = () => {
            suggestionWidgets.clear();
            createSuggestionWidget({
                inputId: 'student-input',
                containerId: 'student-suggestions',
                hiddenId: 'student-id',
                onSelect: () => {
                    const eventInput = document.getElementById('event-input');
                    if (eventInput) {
                        eventInput.focus();
                        if (typeof eventInput.select === 'function') {
                            eventInput.select();
                        }
                    }
                },
            });

            createSuggestionWidget({
                inputId: 'event-input',
                containerId: 'event-suggestions',
                hiddenId: 'event-id',
                onSelect: () => {
                    const eventInput = document.getElementById('event-input');
                    if (eventInput) {
                        eventInput.focus();
                        if (typeof eventInput.select === 'function') {
                            eventInput.select();
                        }
                    }
                },
            });
        };

        const clearQuickAssignmentFields = () => {
            const studentInput = document.getElementById('student-input');
            const eventInput = document.getElementById('event-input');
            const studentId = document.getElementById('student-id');
            const eventId = document.getElementById('event-id');
            const studentSuggestions = document.getElementById('student-suggestions');
            const eventSuggestions = document.getElementById('event-suggestions');

            if (studentInput) {
                studentInput.value = '';
            }
            if (studentId) {
                studentId.value = '';
            }
            if (eventInput) {
                eventInput.value = '';
            }
            if (eventId) {
                eventId.value = '';
            }
            if (studentSuggestions) {
                studentSuggestions.innerHTML = '';
            }
            if (eventSuggestions) {
                eventSuggestions.innerHTML = '';
            }

            suggestionWidgets.get('student-suggestions')?.resetHighlight();
            suggestionWidgets.get('event-suggestions')?.resetHighlight();

            if (studentInput) {
                studentInput.focus();
            }
        };

        const bindGlobalListeners = () => {
            if (globalsBound) {
                return;
            }
            globalsBound = true;

            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Enter' || !event.shiftKey) {
                    return;
                }
                const form = document.getElementById('quick-assignment-form');
                if (!form) {
                    return;
                }
                const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
                if (!submitButton) {
                    return;
                }
                event.preventDefault();
                submitButton.click();
            });

            document.body.addEventListener('htmx:afterRequest', (event) => {
                const form = document.getElementById('quick-assignment-form');
                if (!form || event.detail?.elt !== form) {
                    return;
                }
                const status = event.detail?.xhr?.status ?? 0;
                if (status >= 200 && status < 300) {
                    pendingFormReset = true;
                    clearQuickAssignmentFields();
                }
            });

            document.body.addEventListener('htmx:afterSwap', (event) => {
                const targetId = event.target?.id;
                if (!targetId) {
                    return;
                }
                const widget = suggestionWidgets.get(targetId);
                if (widget) {
                    widget.resetHighlight();
                }
                if (targetId === 'quick-assignments-panel') {
                    initQuickAssignmentUI();
                    if (pendingFormReset) {
                        clearQuickAssignmentFields();
                        pendingFormReset = false;
                    }
                }
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            initQuickAssignmentUI();
            bindGlobalListeners();
        });
    })();
</script>
{% endblock %}
