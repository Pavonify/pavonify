{% extends "sportsday/base.html" %}
{% block title %}Sports Day · Import events{% endblock %}
{% block content %}
<section class="space-y-6">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <p class="text-sm uppercase tracking-widest text-slate-400">Events</p>
            <h1 class="text-2xl font-semibold">Bulk import events</h1>
            <p class="text-sm text-slate-400">Upload a CSV to create events for {{ meet.name }}.</p>
        </div>
        <a href="{% url 'sportsday:events' %}?meet={{ meet.slug }}" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-slate-300 hover:border-sky-500/40 hover:text-sky-200">Back to events</a>
    </div>

    {% if summary %}
        <div class="rounded-xl border border-slate-800 bg-slate-900/70 p-4 text-sm text-slate-200">
            <p class="font-semibold text-emerald-300">Import complete</p>
            <ul class="mt-2 list-disc space-y-1 pl-5">
                <li>{{ summary.created }} events created</li>
                <li>{{ summary.skipped }} duplicates skipped</li>
                {% if summary.errors %}
                    <li class="text-amber-200">{{ summary.errors|length }} issues encountered:</li>
                    <ul class="list-disc space-y-1 pl-6 text-amber-100">
                        {% for error in summary.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </ul>
        </div>
    {% endif %}

    {% if errors %}
        <div class="rounded-xl border border-rose-800/60 bg-rose-950/40 p-4 text-sm text-rose-100">
            <p class="font-semibold">Please fix the following:</p>
            <ul class="mt-2 list-disc space-y-1 pl-5">
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 space-y-4">
        {% csrf_token %}
        <div class="space-y-2 text-sm">
            <label class="block text-xs uppercase tracking-widest text-slate-500">Events CSV</label>
            {{ form.csv_file }}
            <p class="text-xs text-slate-500">Expected headers: Event, Grade, M/F, Time (24-hour, e.g. 0820).</p>
        </div>
        <div class="space-y-2 text-sm">
            <label class="block text-xs uppercase tracking-widest text-slate-500">Max competitors</label>
            {{ form.capacity_override }}
            <p class="text-xs text-slate-500">Optional. Applies the same capacity to all imported events.</p>
        </div>
        <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-sky-500 px-4 py-2 text-sm font-medium text-slate-950 shadow-lg shadow-sky-500/40 hover:bg-sky-400">Upload and preview</button>
    </form>

    {% if preview %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60">
            <div class="flex items-center justify-between border-b border-slate-800/60 px-4 py-3 text-sm text-slate-300">
                <p class="font-semibold">Preview ({{ preview|length }} events)</p>
                <p class="text-slate-400">All events will be assigned to Matthew McClune.</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-800 text-left text-sm">
                    <thead class="bg-slate-900 text-xs uppercase tracking-widest text-slate-400">
                        <tr>
                            <th class="px-4 py-3">Event</th>
                            <th class="px-4 py-3">Division</th>
                            <th class="px-4 py-3">Gender</th>
                            <th class="px-4 py-3">Time</th>
                            <th class="px-4 py-3">Sport type</th>
                            <th class="px-4 py-3">Capacity</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800 text-slate-200">
                        {% for row in preview %}
                            <tr>
                                <td class="px-4 py-3 align-top">{{ row.name }}</td>
                                <td class="px-4 py-3 align-top">
                                    {{ row.grade_min }}{% if row.grade_min != row.grade_max %}–{{ row.grade_max }}{% endif %}
                                    <span class="ml-2 rounded-full border border-slate-700 px-2 py-0.5 text-[11px] uppercase tracking-wide text-slate-400">{% if row.grade_connector == 'range' %}Range (to){% else %}Multi (&){% endif %}</span>
                                </td>
                                <td class="px-4 py-3 align-top">{{ row.gender_limit }}</td>
                                <td class="px-4 py-3 align-top">{% if row.schedule_dt %}{{ row.schedule_dt|date:"H:i" }}{% else %}—{% endif %}</td>
                                <td class="px-4 py-3 align-top">{{ row.sport_type.label }}</td>
                                <td class="px-4 py-3 align-top">{{ row.capacity }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <form method="post" class="flex items-center justify-end gap-3 border-t border-slate-800/60 px-4 py-3">
                {% csrf_token %}
                <input type="hidden" name="payload" value="{{ payload_json|escape }}" />
                <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-medium text-emerald-950 shadow-lg shadow-emerald-500/40 hover:bg-emerald-400">Confirm import</button>
            </form>
        </div>
    {% endif %}
</section>
{% endblock %}
