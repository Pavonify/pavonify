{% extends "sportsday/base.html" %}
{% block title %}Sports Day · Participants · {{ event.name }}{% endblock %}
{% block content %}
<section class="space-y-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <p class="text-sm uppercase tracking-widest text-slate-400">Participants</p>
            <h1 class="text-2xl font-semibold">{{ event.name }}</h1>
            <p class="text-sm text-slate-400">Tick students to add them to the start list.</p>
        </div>
        <div class="flex flex-wrap gap-2 text-sm">
            <a href="{% url 'sportsday:events' %}?meet={{ event.meet.slug }}" class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-4 py-2 text-slate-200 hover:border-sky-500/40 hover:text-sky-100">Back to events</a>
            <a href="{% url 'sportsday:event-detail' event.pk %}" class="inline-flex items-center gap-2 rounded-full bg-sky-500 px-4 py-2 font-medium text-slate-900 shadow-lg shadow-sky-500/40 hover:bg-sky-400">Manage event</a>
        </div>
    </div>

    {% if lock_reason %}
        <div class="rounded-xl border border-amber-500/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-200">{{ lock_reason }}</div>
    {% endif %}

    <form method="post" class="space-y-6">
        {% csrf_token %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
            <h2 class="text-lg font-semibold text-slate-100">Eligible students</h2>
            <p class="text-sm text-slate-400">Meet: {{ event.meet.name }} · Grades {{ event.grade_min }}{% if event.grade_min != event.grade_max %}–{{ event.grade_max }}{% endif %} · {{ event.get_gender_limit_display }}</p>
            <div class="mt-6 grid gap-6 lg:grid-cols-[2fr,1fr]">
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-xs uppercase tracking-widest text-slate-500">
                        <span>Eligible students</span>
                        <span>{{ eligible_students|length }}</span>
                    </div>
                    <div class="max-h-[28rem] overflow-y-auto rounded-xl border border-slate-800 bg-slate-950/60">
                        {% if eligible_students %}
                            <ul class="divide-y divide-slate-800" data-participants-list>
                                {% for student in eligible_students %}
                                    {% with house=student.house|default:"Unassigned" grade=student.grade|default:"Unassigned" %}
                                        <li>
                                            <label class="group relative flex w-full cursor-pointer items-center gap-3 px-4 py-3 text-sm text-slate-200 transition hover:bg-slate-800/40 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/40" data-participant-card>
                                                <input type="checkbox" name="participants" value="{{ student.pk }}" class="peer sr-only" data-participant-checkbox data-house="{{ house }}" data-grade="{{ grade }}" {% if student.pk in assigned_student_ids %}checked{% endif %} {% if lock_reason %}disabled{% endif %}>
                                                <div class="flex flex-1 flex-col gap-0.5">
                                                    <span class="font-medium text-slate-100">{{ student.last_name }}, {{ student.first_name }}</span>
                                                    <span class="text-xs text-slate-400">Grade {{ student.grade|default:"—" }} · {{ student.house|default:"Unassigned" }}</span>
                                                </div>
                                                <div class="flex items-center gap-2 text-xs">
                                                    <span class="rounded-full border border-slate-700 px-3 py-1 font-medium text-slate-200 transition group-hover:border-slate-600 peer-checked:hidden">Select</span>
                                                    <span class="hidden items-center gap-1 rounded-full border border-sky-400 bg-sky-500/10 px-3 py-1 font-semibold text-sky-100 transition peer-checked:flex">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                            <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 0 1 .006 1.414l-7.25 7.364a1 1 0 0 1-1.437.004L3.29 9.413a1 1 0 1 1 1.42-1.407l3.065 3.094 6.54-6.633a1 1 0 0 1 1.389-.178Z" clip-rule="evenodd" />
                                                        </svg>
                                                        Selected
                                                    </span>
                                                    <span class="rounded-full border border-slate-800 px-3 py-1 text-[0.65rem] uppercase tracking-widest text-slate-500 peer-checked:border-sky-500/40 peer-checked:text-sky-200">{{ house }}</span>
                                                </div>
                                                <div class="pointer-events-none absolute inset-0 rounded-lg border border-transparent transition peer-checked:border-sky-500/40 peer-checked:bg-slate-800/60"></div>
                                            </label>
                                        </li>
                                    {% endwith %}
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="px-4 py-6 text-sm text-slate-400">No students match the filters for this event.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                        <p class="text-xs uppercase tracking-widest text-slate-500">Selected participants</p>
                        <p class="mt-2 text-2xl font-semibold text-slate-100" data-selected-count>
                            {% if event.capacity %}
                                {{ selected_count }} / {{ event.capacity }}
                            {% else %}
                                {{ selected_count }}
                            {% endif %}
                        </p>
                        {% if event.capacity %}
                            <p class="mt-1 text-xs text-slate-500" data-capacity-message>Max participants: {{ event.capacity }}</p>
                        {% endif %}
                    </div>
                    {% if house_summary %}
                        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                            <p class="text-xs uppercase tracking-widest text-slate-500">By house</p>
                            <dl class="mt-2 space-y-1 text-sm text-slate-300">
                                {% for house, count in house_summary %}
                                    <div class="flex items-center justify-between" data-house-count data-house="{{ house }}">
                                        <dt class="text-slate-400">{{ house }}</dt>
                                        <dd class="font-semibold" data-count-value>{{ count }}</dd>
                                    </div>
                                {% endfor %}
                            </dl>
                        </div>
                    {% endif %}
                    {% if grade_summary %}
                        <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-4">
                            <p class="text-xs uppercase tracking-widest text-slate-500">By grade</p>
                            <dl class="mt-2 space-y-1 text-sm text-slate-300">
                                {% for grade, count in grade_summary %}
                                    <div class="flex items-center justify-between" data-grade-count data-grade="{{ grade }}">
                                        <dt class="text-slate-400">{{ grade }}</dt>
                                        <dd class="font-semibold" data-count-value>{{ count }}</dd>
                                    </div>
                                {% endfor %}
                            </dl>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="flex justify-end">
            <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-sky-500 px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-500/40 transition hover:bg-sky-400 disabled:cursor-not-allowed disabled:opacity-60" {% if lock_reason %}disabled{% endif %}>Save participants</button>
        </div>
    </form>
    {% if not lock_reason %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');
    if (!form) {
        return;
    }
    const checkboxes = Array.from(document.querySelectorAll('[data-participant-checkbox]'));
    const selectedCountEl = document.querySelector('[data-selected-count]');
    const capacityMessageEl = document.querySelector('[data-capacity-message]');
    const capacity = parseInt('{{ event.capacity }}', 10) || 0;
    const houseRows = Array.from(document.querySelectorAll('[data-house-count]'));
    const gradeRows = Array.from(document.querySelectorAll('[data-grade-count]'));
    const initialDisabled = new WeakSet();

    checkboxes.forEach((checkbox) => {
        if (checkbox.disabled) {
            initialDisabled.add(checkbox);
        }
        checkbox.addEventListener('change', updateState);
    });

    function refreshInteractiveState() {
        checkboxes.forEach((checkbox) => {
            const card = checkbox.closest('[data-participant-card]');
            if (!card) {
                return;
            }
            if (checkbox.disabled) {
                card.setAttribute('aria-disabled', 'true');
                card.classList.add('cursor-not-allowed', 'opacity-60');
                card.classList.remove('cursor-pointer');
            } else {
                card.setAttribute('aria-disabled', 'false');
                card.classList.remove('cursor-not-allowed', 'opacity-60');
                card.classList.add('cursor-pointer');
            }
        });
    }

    function updateState() {
        const houseTotals = {};
        const gradeTotals = {};
        let selectedTotal = 0;

        checkboxes.forEach((checkbox) => {
            if (checkbox.checked) {
                selectedTotal += 1;
                const house = checkbox.dataset.house || 'Unassigned';
                const grade = checkbox.dataset.grade || 'Unassigned';
                houseTotals[house] = (houseTotals[house] || 0) + 1;
                gradeTotals[grade] = (gradeTotals[grade] || 0) + 1;
            }
        });

        houseRows.forEach((row) => {
            const valueEl = row.querySelector('[data-count-value]');
            if (valueEl) {
                valueEl.textContent = houseTotals[row.dataset.house] || 0;
            }
        });

        gradeRows.forEach((row) => {
            const valueEl = row.querySelector('[data-count-value]');
            if (valueEl) {
                valueEl.textContent = gradeTotals[row.dataset.grade] || 0;
            }
        });

        if (selectedCountEl) {
            if (capacity) {
                selectedCountEl.textContent = `${selectedTotal} / ${capacity}`;
            } else {
                selectedCountEl.textContent = `${selectedTotal}`;
            }
        }

        const atCapacity = capacity && selectedTotal >= capacity;
        checkboxes.forEach((checkbox) => {
            if (initialDisabled.has(checkbox)) {
                return;
            }
            if (atCapacity && !checkbox.checked) {
                checkbox.disabled = true;
                checkbox.dataset.capacityDisabled = 'true';
            } else if (!atCapacity && checkbox.dataset.capacityDisabled === 'true') {
                checkbox.disabled = false;
                delete checkbox.dataset.capacityDisabled;
            }
        });

        if (capacityMessageEl) {
            capacityMessageEl.classList.toggle('text-amber-300', atCapacity);
        }

        refreshInteractiveState();
    }

    updateState();
    });
    </script>
    {% endif %}
</section>
{% endblock %}
