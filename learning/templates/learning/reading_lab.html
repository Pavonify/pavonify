<div class="container">
    <h1>Reading Lab</h1>
    
    <!-- Flash Messages -->
    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    <form id="reading-lab-form" method="POST">
        {% csrf_token %}

        <!-- Step 1: Select Vocabulary List -->
        <label for="vocab_list">Select a Vocabulary List:</label>
        <select id="vocab_list" name="vocab_list" required>
            <option value="">-- Choose a list --</option>
            {% for vocab_list in vocabulary_lists %}
            <option value="{{ vocab_list.id }}" data-source="{{ vocab_list.source_language }}" data-target="{{ vocab_list.target_language }}">
                {{ vocab_list.name }} ({{ vocab_list.source_language }} → {{ vocab_list.target_language }})
            </option>
            {% endfor %}
        </select>

        <!-- Step 2: Select Words (Initially Hidden) -->
        <div id="word-selection" style="display:none;">
            <h3>Select Words to Include:</h3>
            <div id="word-list"></div>
        </div>

        <!-- Step 3: Select Exam Board -->
        <label for="exam_board">Exam Board:</label>
        <select id="exam_board" name="exam_board" required>
            <option value="">-- Choose an exam board --</option>
            {% for board, topics in exam_board_topics.items %}
            <option value="{{ board }}">{{ board }}</option>
            {% endfor %}
        </select>

        <!-- Step 4: Select Topic (Initially Hidden) -->
        <div id="topic-selection" style="display:none;">
            <label for="topic">Select a Topic:</label>
            <select id="topic" name="topic" required></select>
        </div>

        <!-- Step 5: Select CEFR Level -->
        <label for="level">Select Level:</label>
        <select id="level" name="level" required>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
        </select>

        <!-- Step 6: Word Count -->
        <label for="word_count">Word Count (max 200):</label>
        <input type="number" id="word_count" name="word_count" min="50" max="200" required>

        <!-- Generate Button -->
        <button type="submit" id="generate-button">Generate</button>

        <!-- Loading Indicator -->
        <div id="loading" style="display:none;">⏳ Generating text, please wait...</div>
    </form>

    <!-- Display AI-Generated Text -->
    <div id="generated-text" style="display:none;">
        <h2>Generated Parallel Text</h2>
        <p><strong>Source Language:</strong></p>
        <p id="generated-source"></p>
        <p><strong>Target Language:</strong></p>
        <p id="generated-target"></p>
    </div>
</div>

<!-- JavaScript for Dynamic UI -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const vocabSelect = document.getElementById("vocab_list");
    const wordSelection = document.getElementById("word-selection");
    const wordListDiv = document.getElementById("word-list");
    const examBoardSelect = document.getElementById("exam_board");
    const topicSelect = document.getElementById("topic");
    const topicSelectionDiv = document.getElementById("topic-selection");
    const form = document.getElementById("reading-lab-form");
    const loadingDiv = document.getElementById("loading");
    const generateButton = document.getElementById("generate-button");
    const generatedTextDiv = document.getElementById("generated-text");
    const generatedSource = document.getElementById("generated-source");
    const generatedTarget = document.getElementById("generated-target");

    // Fetch words when a vocab list is selected
    vocabSelect.addEventListener("change", function() {
        const listId = this.value;
        if (listId) {
            fetch(`/get-vocab-words/${listId}/`)
            .then(response => response.json())
            .then(data => {
                wordListDiv.innerHTML = ""; // Clear previous words
                data.words.forEach(word => {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "selected_words";
                    checkbox.value = word.id;
                    checkbox.id = `word-${word.id}`;

                    const label = document.createElement("label");
                    label.htmlFor = `word-${word.id}`;
                    label.textContent = `${word.word} (${word.translation})`;

                    const br = document.createElement("br");

                    wordListDiv.appendChild(checkbox);
                    wordListDiv.appendChild(label);
                    wordListDiv.appendChild(br);
                });
                wordSelection.style.display = "block";
            });
        } else {
            wordSelection.style.display = "none";
        }
    });

    // Show topic dropdown when an exam board is selected
    examBoardSelect.addEventListener("change", function() {
        const selectedBoard = this.value;
        if (selectedBoard) {
            fetch(`/get-exam-board-topics/${selectedBoard}/`)
            .then(response => response.json())
            .then(data => {
                topicSelect.innerHTML = "";
                data.topics.forEach(topic => {
                    const option = document.createElement("option");
                    option.value = topic;
                    option.textContent = topic;
                    topicSelect.appendChild(option);
                });
                topicSelectionDiv.style.display = "block";
            });
        } else {
            topicSelectionDiv.style.display = "none";
        }
    });

    // Handle form submission
    form.addEventListener("submit", function(event) {
        event.preventDefault();
        generateButton.disabled = true;
        loadingDiv.style.display = "block";

        fetch("{% url 'reading_lab' %}", {
            method: "POST",
            body: new FormData(form)
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.style.display = "none";
            generateButton.disabled = false;
            if (data.error) {
                alert(data.error);
            } else {
                generatedSource.textContent = data.generated_text_source;
                generatedTarget.textContent = data.generated_text_target;
                generatedTextDiv.style.display = "block";
            }
        });
    });
});
</script>
