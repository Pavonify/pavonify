{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assignment Analytics - {{ assignment.name }}</title>
  <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Fonts: Poppins for body and Fredoka One for headings -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1A73E8;
      --accent: #F2A03D;
      --secondary-accent: #34A853;
      --background: #F2EFE9;
      --dark: #0D0D0D;
      --highlight: #A6173D;
    }
    /* Global Reset & Base */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background);
      color: var(--dark);
      margin: 0;
      padding: 0 20px 20px 20px;
    }
    a { color: var(--accent); text-decoration: none; transition: color 0.3s; }
    a:hover { color: var(--highlight); }
    h1, h2, h3, h4, h5, h6 { margin: 0.5em 0; }
    h1 { font-family: 'Fredoka One', cursive; font-size: 3rem; color: var(--primary); }
    h2 { font-family: 'Fredoka One', cursive; font-size: 2rem; color: var(--primary); }
    /* Top Navigation Bar */
    .top-nav {
      background-color: var(--primary);
      color: #fff;
      padding: 8px 20px;
      display: flex;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .top-nav a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
    }
    .container {
      max-width: 1000px;
      margin: 80px auto 20px;  /* leave space for fixed top nav */
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      border: 1px solid transparent;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      margin-right: 5px;
    }
    .tab.active {
      border: 1px solid #ddd;
      border-bottom: 2px solid #fff;
      background: #f9f9f9;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 10px; text-align: center; font-size: 16px; }
    th { background: var(--primary); color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    /* Difficulty Meter */
    .difficulty-bar {
      height: 10px;
      background: red;
      width: 0%;
      transition: width 0.3s;
    }
    /* Word Clouds */
    .word-cloud {
      border: 1px solid #ddd;
      padding: 10px;
      min-height: 100px;
      margin-bottom: 20px;
    }
    .word-cloud span {
      margin: 5px;
      display: inline-block;
      transition: transform 0.3s;
    }
    .btn-gen {
      background: #005f73;
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      min-height: 44px;
      min-width: 140px;
      transition: background 0.3s;
    }
    .btn-gen:hover,
    .btn-gen:focus {
      background: #0a9396;
      outline: none;
    }
    #gen-clipboard {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: 'Poppins', sans-serif;
    }
    #copy-btn,
    #close-btn {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    #copy-btn {
      background: #005f73;
      color: #fff;
    }
    #close-btn {
      background: #666;
      color: #fff;
    }
    #copy-btn:hover,
    #close-btn:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <a href="{% url 'teacher_dashboard' %}?pane=classes">&larr; Back to Dashboard</a>
  </div>

  <div class="container">
    <h1>Assignment Analytics: {{ assignment.name }}</h1>

    <!-- Sticky action bar -->
    <div id="teach-now-bar" style="position:sticky; top:60px; z-index:999; background:#fff; padding:8px; border:1px solid #eee; border-radius:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; margin-bottom:12px;">
      <button class="btn-gen" data-type="do_now">Re-teach Do-Now</button>
      <button class="btn-gen" data-type="exit_tickets">Exit Tickets</button>
      <button class="btn-gen" data-type="hinge">Live Hinge</button>
      <button class="btn-gen" data-type="sentences">Sentence Builders</button>
      <button class="btn-gen" data-type="game_seed">Mini-game</button>
    </div>

    <!-- Minimal modal for clipboard -->
    <div id="gen-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4);">
      <div style="max-width:700px; margin:10vh auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <h3 id="gen-title">Generated Activity</h3>
        <textarea id="gen-clipboard" rows="12"></textarea>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="copy-btn">Copy to Clipboard</button>
          <button id="close-btn">Close</button>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="student-summary">Student Summary</div>
      <div class="tab" data-tab="word-summary">Word Summary</div>
      <div class="tab" data-tab="feedback">Feedback</div>
    </div>
    
    <!-- Overview Tab -->
    <div class="tab-content active" id="overview">
      <h2>Overview</h2>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Points Earned</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for progress in progress_list %}
          <tr>
            <td>{{ progress.student.username }}</td>
            <td>{{ progress.points_earned }}</td>
            <td>
              {% if progress.completed %}
                <span style="color:green;"><i class="fas fa-check-circle"></i> Completed</span>
              {% else %}
                <span style="color:red;"><i class="fas fa-times-circle"></i> Incomplete</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">No progress data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Student Summary Tab -->
    <div class="tab-content" id="student-summary">
      <h2>Student Summary</h2>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Words Aced ðŸ’ª</th>
            <th>Attempts Wrong ðŸ‘Ž</th>
          </tr>
        </thead>
        <tbody>
          {% for summary in student_summary %}
          <tr>
            <td>{{ summary.student.first_name }} {{ summary.student.last_name }}</td>
            <td>
              {% for word in summary.words_aced %}
                {{ word }}<br>
              {% endfor %}
            </td>
            <td>
              {% for word, count in summary.attempts_wrong %}
                {{ word }} ({{ count }})<br>
              {% endfor %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">No student summary data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Word Summary Tab -->
    <div class="tab-content" id="word-summary">
      <h2>Word Summary</h2>
      <p class="legend"><em>Difficulty meter shows percentage of attempts that were incorrect.</em></p>
      <table>
        <thead>
          <tr>
            <th>Word</th>
            <th>Difficulty Meter</th>
            <th>Student Count</th>
          </tr>
        </thead>
        <tbody>
          {% for word in word_summary %}
          <tr>
            <td>{{ word.word }}</td>
            <td>
              <div class="difficulty-bar" title="{{ word.difficulty_percentage|floatformat:1 }}% of attempts incorrect" style="width: {{ word.difficulty_percentage|floatformat:0 }}%;"></div>
            </td>
            <td>{{ word.students_difficulty }} students found this word difficult</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">No word summary data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Feedback Tab -->
    <div class="tab-content" id="feedback">
      <h2>Feedback</h2>
      <div>
        <h3>Word Cloud (Easy)</h3>
        <div class="word-cloud" id="word-cloud-easy">
          {% for word in word_cloud_easy %}
            <span style="font-size: 16px;">{{ word }}</span>
          {% endfor %}
        </div>
      </div>
      <div>
        <h3>Word Cloud (Difficult)</h3>
        <div class="word-cloud" id="word-cloud-difficult">
          {% for word in top_difficult_words %}
            <span data-difficulty="{{ word.students_difficulty }}">{{ word.word }}</span>
          {% endfor %}
        </div>
      </div>
      <div>
        <h3>Top 10 Difficult Words</h3>
        <ol>
          {% for word in top_difficult_words %}
            <li>{{ word.word }} - {{ word.students_difficulty }} students</li>
          {% empty %}
            <li>No data available.</li>
          {% endfor %}
        </ol>
      </div>
    </div>
  </div>

  <script>
    // Tab switching logic.
    const tabs = document.querySelectorAll(".tab");
    const tabContents = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tabContents.forEach(tc => tc.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.getAttribute("data-tab")).classList.add("active");
      });
    });
    
    // Enhance Word Cloud for Difficult Words:
    // Use the "data-difficulty" attribute to set a dynamic font size.
    function enhanceDifficultWordCloud() {
      const cloud = document.getElementById("word-cloud-difficult");
      const spans = cloud.querySelectorAll("span");
      spans.forEach(span => {
        const difficulty = parseInt(span.getAttribute("data-difficulty")) || 0;
        // Compute a font size: base 16px plus 2px per student (adjust scaling as needed)
        const fontSize = 16 + (difficulty * 2);
        span.style.fontSize = fontSize + "px";
        // Random color from a preset list
        const colors = ["#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6"];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        span.style.color = randomColor;
        // Random rotation between -15 and 15 degrees.
        const rotation = Math.floor(Math.random() * 31) - 15;
        span.style.display = "inline-block";
        span.style.transform = "rotate(" + rotation + "deg)";
      });
    }
    
    // Enhance the easy word cloud with random colors and rotations (but constant size)
    function enhanceEasyWordCloud() {
      const cloud = document.getElementById("word-cloud-easy");
      const spans = cloud.querySelectorAll("span");
      spans.forEach(span => {
        span.style.fontSize = "16px";
        const colors = ["#3498db", "#2ecc71", "#f1c40f", "#e67e22", "#9b59b6"];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        span.style.color = randomColor;
        const rotation = Math.floor(Math.random() * 31) - 15;
        span.style.display = "inline-block";
        span.style.transform = "rotate(" + rotation + "deg)";
      });
    }

    enhanceDifficultWordCloud();
    enhanceEasyWordCloud();
  </script>
  <script>
    (function(){
      const assignmentId = "{{ assignment.id|escapejs }}";

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      function postJSON(url, data) {
        const csrfToken = getCookie('csrftoken');
        return fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken || '',
          },
          body: JSON.stringify(data),
          credentials: 'include',
        }).then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        });
      }

      function openModal(title, text) {
        document.getElementById('gen-title').textContent = title;
        document.getElementById('gen-clipboard').value = text;
        document.getElementById('gen-modal').style.display = 'block';
      }

      function closeModal() {
        document.getElementById('gen-modal').style.display = 'none';
      }

      document.querySelectorAll('.btn-gen').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const type = btn.getAttribute('data-type');
          try {
            const response = await postJSON("{% url 'api_generate_activity' %}", {
              assignment_id: assignmentId,
              activity_type: type,
            });
            openModal(response.activity.title || 'Generated', response.clipboard || '');
          } catch (error) {
            openModal('Error', 'Could not generate activity.');
          }
        });
      });

      document.getElementById('close-btn').addEventListener('click', closeModal);
      document.getElementById('gen-modal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
          closeModal();
        }
      });

      document.getElementById('copy-btn').addEventListener('click', async () => {
        const textarea = document.getElementById('gen-clipboard');
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        try {
          await navigator.clipboard.writeText(textarea.value);
        } catch (err) {
          document.execCommand('copy');
        }
      });
    })();
  </script>
{% include 'messages.html' %}
</body>
</html>
