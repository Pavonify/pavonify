{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assignment Analytics - {{ assignment.name }}</title>
  <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Fonts: Poppins for body and Fredoka One for headings -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1A73E8;
      --accent: #F2A03D;
      --secondary-accent: #34A853;
      --background: #F2EFE9;
      --dark: #0D0D0D;
      --highlight: #A6173D;
    }
    /* Global Reset & Base */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background);
      color: var(--dark);
      margin: 0;
      padding: 0 20px 20px 20px;
    }
    a { color: var(--accent); text-decoration: none; transition: color 0.3s; }
    a:hover { color: var(--highlight); }
    h1, h2, h3, h4, h5, h6 { margin: 0.5em 0; }
    h1 { font-family: 'Fredoka One', cursive; font-size: 3rem; color: var(--primary); }
    h2 { font-family: 'Fredoka One', cursive; font-size: 2rem; color: var(--primary); }
    /* Top Navigation Bar */
    .top-nav {
      background-color: var(--primary);
      color: #fff;
      padding: 8px 20px;
      display: flex;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .top-nav a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
    }
    .container {
      max-width: 1000px;
      margin: 80px auto 20px;  /* leave space for fixed top nav */
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      border: 1px solid transparent;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      margin-right: 5px;
    }
    .tab.active {
      border: 1px solid #ddd;
      border-bottom: 2px solid #fff;
      background: #f9f9f9;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 10px; text-align: center; font-size: 16px; }
    th { background: var(--primary); color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    /* Difficulty Meter */
    .difficulty-bar {
      height: 10px;
      background: red;
      width: 0%;
      transition: width 0.3s;
    }
    .btn-gen {
      background: #005f73;
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      min-height: 44px;
      min-width: 140px;
      transition: background 0.3s;
    }
    .btn-gen:hover,
    .btn-gen:focus {
      background: #0a9396;
      outline: none;
    }
    .btn-download {
      background: #fff;
      border: 2px solid var(--primary);
      color: var(--primary);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-download:hover,
    .btn-download:focus {
      background: var(--primary);
      color: #fff;
    }
    #teach-now-bar {
      position: sticky;
      top: 72px;
      z-index: 400;
      background: #fff;
      padding: 8px 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .teach-now-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
    }
    #gen-clipboard {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: 'Poppins', sans-serif;
      height: 50vh;
      resize: vertical;
    }
    #copy-btn,
    #close-btn {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    #copy-btn {
      background: #005f73;
      color: #fff;
    }
    #close-btn {
      background: #666;
      color: #fff;
    }
    #copy-btn:hover,
    #close-btn:hover {
      opacity: 0.9;
    }
    #gen-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      z-index: 1200;
      backdrop-filter: blur(2px);
      padding: 24px 16px;
      overflow-y: auto;
      align-items: flex-start;
      justify-content: center;
      pointer-events: auto;
    }
    #gen-modal * {
      pointer-events: auto;
    }
    .modal-dialog {
      width: 100%;
      max-width: 720px;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.18);
      position: relative;
      max-height: 80vh;
      overflow: auto;
      pointer-events: auto;
    }
    .feedback-cards {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-bottom: 24px;
      text-align: left;
    }
    .feedback-card {
      background: #f5f9ff;
      border: 1px solid rgba(26, 115, 232, 0.15);
      border-radius: 14px;
      padding: 18px;
      position: relative;
      overflow: hidden;
    }
    .feedback-card::after {
      content: "";
      position: absolute;
      top: -40px;
      right: -40px;
      width: 120px;
      height: 120px;
      background: rgba(26, 115, 232, 0.08);
      border-radius: 50%;
    }
    .feedback-card h4 {
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--dark);
      margin-bottom: 8px;
    }
    .feedback-card .metric {
      font-size: 2.4rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    .feedback-card p {
      margin: 0;
      font-size: 0.85rem;
      color: #4a4a4a;
    }
    .feedback-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      margin-bottom: 24px;
      text-align: left;
    }
    .feedback-panel {
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      border: 1px solid #eee;
      box-shadow: 0 12px 24px rgba(13, 13, 13, 0.04);
    }
    .feedback-panel.full-width {
      grid-column: 1 / -1;
    }
    .feedback-panel h3 {
      margin-bottom: 12px;
      font-size: 1.2rem;
      color: var(--primary);
    }
    .priority-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .priority-item-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    .progress-track {
      width: 100%;
      height: 10px;
      background: #f0f4ff;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f97316, #dc2626);
    }
    .focus-students {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .focus-students li {
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(26, 115, 232, 0.08);
    }
    .focus-students .student-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .focus-students .student-meta {
      font-size: 0.85rem;
      color: #555;
    }
    .focus-students .student-needs {
      font-size: 0.85rem;
      margin-top: 4px;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      background: rgba(52, 168, 83, 0.12);
      color: #166534;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .chip-muted {
      background: #f3f4f6;
      color: #6b7280;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.9rem;
    }
    .mini-table {
      width: 100%;
      border-collapse: collapse;
    }
    .mini-table th,
    .mini-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
      font-size: 0.95rem;
    }
    .mini-table th {
      background: rgba(26, 115, 232, 0.1);
      color: #1a237e;
    }
    @media (max-width: 640px) {
      #teach-now-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .teach-now-actions {
        width: 100%;
        justify-content: center;
      }
      .btn-download {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <a href="{% url 'teacher_dashboard' %}?pane=classes">&larr; Back to Dashboard</a>
  </div>

  <div class="container">
    <h1>Assignment Analytics: {{ assignment.name }}</h1>

    <!-- Sticky action bar -->
    <div id="teach-now-bar">
      <div class="teach-now-actions">
        <button class="btn-gen" data-type="do_now">Re-teach Do-Now</button>
        <button class="btn-gen" data-type="exit_tickets">Exit Tickets</button>
        <button class="btn-gen" data-type="hinge">Live Hinge</button>
        <button class="btn-gen" data-type="sentences">Sentence Builders</button>
        <button class="btn-gen" data-type="game_seed">Mini-game</button>
      </div>
      <a class="btn-download" href="{% url 'api_export_progress' assignment.id %}">
        <i class="fas fa-file-arrow-down" aria-hidden="true"></i>
        <span>Download Progress (.xlsx)</span>
      </a>
    </div>

    <!-- Minimal modal for clipboard -->
    <div id="gen-modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" tabindex="-1" aria-labelledby="gen-title">
        <h3 id="gen-title">Generated Activity</h3>
        <textarea id="gen-clipboard" rows="12"></textarea>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="copy-btn" type="button">Copy to Clipboard</button>
          <button id="close-btn" type="button">Close</button>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="student-summary">Student Summary</div>
      <div class="tab" data-tab="word-summary">Word Summary</div>
      <div class="tab" data-tab="feedback">Feedback</div>
    </div>
    
    <!-- Overview Tab -->
    <div class="tab-content active" id="overview">
      <h2>Overview</h2>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Points Earned</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for progress in progress_list %}
          <tr>
            <td>{{ progress.student.username }}</td>
            <td>{{ progress.points_earned }}</td>
            <td>
              {% if progress.completed %}
                <span style="color:green;"><i class="fas fa-check-circle"></i> Completed</span>
              {% else %}
                <span style="color:red;"><i class="fas fa-times-circle"></i> Incomplete</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">No progress data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Student Summary Tab -->
    <div class="tab-content" id="student-summary">
      <h2>Student Summary</h2>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Words Aced 💪</th>
            <th>Attempts Wrong 👎</th>
          </tr>
        </thead>
        <tbody>
          {% for summary in student_summary %}
          <tr>
            <td>{{ summary.student.first_name }} {{ summary.student.last_name }}</td>
            <td>
              {% for word in summary.words_aced %}
                {{ word }}<br>
              {% endfor %}
            </td>
            <td>
              {% for word, count in summary.attempts_wrong %}
                {{ word }} ({{ count }})<br>
              {% endfor %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">No student summary data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Word Summary Tab -->
    <div class="tab-content" id="word-summary">
      <h2>Word Summary</h2>
      <p class="legend"><em>Difficulty meter shows percentage of attempts that were incorrect.</em></p>
      <table>
        <thead>
          <tr>
            <th>Word</th>
            <th>Difficulty Meter</th>
            <th>Student Count</th>
          </tr>
        </thead>
        <tbody>
          {% for word in word_summary %}
          <tr>
            <td>{{ word.word }}</td>
            <td>
              <div class="difficulty-bar" title="{{ word.difficulty_percentage|floatformat:1 }}% of attempts incorrect" style="width: {{ word.difficulty_percentage|floatformat:0 }}%;"></div>
            </td>
            <td>{{ word.students_difficulty }} students found this word difficult</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3">No word summary data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Feedback Tab -->
    <div class="tab-content" id="feedback">
      <h2>Feedback</h2>
      <div class="feedback-cards">
        <div class="feedback-card">
          <h4>Class accuracy</h4>
          <div class="metric">{{ class_accuracy|floatformat:1 }}%</div>
          <p>{{ total_attempts }} attempts logged across {{ student_summary|length }} students.</p>
        </div>
        <div class="feedback-card">
          <h4>Completed</h4>
          <div class="metric">{{ students_completed }}</div>
          <p>students finished the assignment.</p>
        </div>
        <div class="feedback-card">
          <h4>Reteach candidates</h4>
          <div class="metric">{{ struggling_word_count }}</div>
          <p>words below 50% accuracy.</p>
        </div>
        <div class="feedback-card">
          <h4>Action tips</h4>
          <p style="font-size: 0.95rem; margin-top: 24px;">Use the quick-action bar to launch activities targeted at these needs.</p>
        </div>
      </div>

      <div class="feedback-grid">
        <div class="feedback-panel">
          <h3>Priority words to re-teach</h3>
          <p style="margin-top:-4px; font-size:0.9rem; color:#555;">High-difficulty words ranked by incorrect attempts.</p>
          <ul class="priority-list">
            {% for word in top_difficult_words|slice:":5" %}
              <li>
                <div class="priority-item-title">
                  <span>{{ word.word }}</span>
                  <span>{{ word.difficulty_percentage|floatformat:0 }}% incorrect</span>
                </div>
                <div class="progress-track" role="presentation">
                  <div class="progress-fill" style="width: {{ word.difficulty_percentage|floatformat:0 }}%;"></div>
                </div>
                <div class="student-meta" style="font-size:0.8rem; color:#666; margin-top:4px;">
                  {{ word.students_difficulty }} student{{ word.students_difficulty|pluralize }} struggled • {{ word.total_attempts }} attempts
                </div>
              </li>
            {% empty %}
              <li>No word difficulty data yet.</li>
            {% endfor %}
          </ul>
        </div>

        <div class="feedback-panel">
          <h3>Students to check in</h3>
          <p style="margin-top:-4px; font-size:0.9rem; color:#555;">Lowest accuracy learners with at least three attempts.</p>
          <ul class="focus-students">
            {% for student in focus_students %}
              <li>
                <div class="student-name">{{ student.name }}</div>
                <div class="student-meta">{{ student.accuracy|floatformat:0 }}% accuracy across {{ student.attempts }} attempts</div>
                {% if student.needs %}
                  <div class="student-needs"><strong>Focus words:</strong> {{ student.needs|join:', ' }}</div>
                {% endif %}
              </li>
            {% empty %}
              <li class="chip-muted">Everyone is on track! 🎉</li>
            {% endfor %}
          </ul>
        </div>

        <div class="feedback-panel">
          <h3>Confidence boosters</h3>
          <p style="margin-top:-4px; font-size:0.9rem; color:#555;">Celebrate the vocabulary the class now owns.</p>
          <div class="chip-row">
            {% if quick_win_words %}
              {% for word in quick_win_words %}
                <span class="chip">{{ word.word }} · {{ word.facility_percentage|floatformat:0 }}%</span>
              {% endfor %}
            {% elif celebration_words %}
              {% for word in celebration_words %}
                <span class="chip">{{ word }}</span>
              {% endfor %}
            {% else %}
              <span class="chip-muted">No mastery highlights yet.</span>
            {% endif %}
          </div>
        </div>

        <div class="feedback-panel full-width">
          <h3>Top 10 difficult words</h3>
          <table class="mini-table">
            <thead>
              <tr>
                <th>Word</th>
                <th>Incorrect attempts</th>
                <th>Students affected</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody>
              {% for word in top_difficult_words %}
                <tr>
                  <td>{{ word.word }}</td>
                  <td>{{ word.wrong_attempts }}</td>
                  <td>{{ word.students_difficulty }}</td>
                  <td>{{ word.difficulty_percentage|floatformat:0 }}%</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4">No data available.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching logic.
    const tabs = document.querySelectorAll(".tab");
    const tabContents = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tabContents.forEach(tc => tc.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.getAttribute("data-tab")).classList.add("active");
      });
    });
  </script>
  <script>
    (function(){
      const assignmentId = "{{ assignment.id|escapejs }}";

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      function postJSON(url, data) {
        const csrfToken = getCookie('csrftoken');
        return fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken || '',
          },
          body: JSON.stringify(data),
          credentials: 'include',
        }).then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        });
      }

      const modalOverlay = document.getElementById('gen-modal');
      const modalDialog = modalOverlay ? modalOverlay.querySelector('.modal-dialog') : null;
      const modalTitle = document.getElementById('gen-title');
      const modalTextarea = document.getElementById('gen-clipboard');
      const closeButton = document.getElementById('close-btn');
      const copyButton = document.getElementById('copy-btn');
      const pageBody = document.body;
      let previousBodyOverflow = pageBody ? pageBody.style.overflow : '';
      let lastTriggerButton = null;
      let copyResetTimer = null;

      function resetCopyButton() {
        if (copyResetTimer) {
          window.clearTimeout(copyResetTimer);
          copyResetTimer = null;
        }
        if (copyButton) {
          copyButton.disabled = false;
          copyButton.textContent = 'Copy to Clipboard';
        }
      }

      function openModal(title, text) {
        if (modalTitle) {
          modalTitle.textContent = title;
        }
        if (modalTextarea) {
          modalTextarea.value = text;
          modalTextarea.scrollTop = 0;
        }
        if (modalOverlay) {
          modalOverlay.style.display = 'flex';
          modalOverlay.setAttribute('aria-hidden', 'false');
          modalOverlay.scrollTop = 0;
        }
        if (pageBody) {
          previousBodyOverflow = pageBody.style.overflow;
          pageBody.style.overflow = 'hidden';
        }
        if (modalTextarea) {
          try {
            modalTextarea.focus({ preventScroll: true });
          } catch (err) {
            modalTextarea.focus();
          }
        } else if (modalDialog) {
          try {
            modalDialog.focus({ preventScroll: true });
          } catch (err) {
            modalDialog.focus();
          }
        }
        document.addEventListener('keydown', handleDocumentKeydown);
      }

      function closeModal() {
        if (modalOverlay) {
          modalOverlay.style.display = 'none';
          modalOverlay.setAttribute('aria-hidden', 'true');
        }
        if (pageBody) {
          pageBody.style.overflow = previousBodyOverflow || '';
        }
        if (lastTriggerButton) {
          lastTriggerButton.focus();
          lastTriggerButton = null;
        }
        resetCopyButton();
        document.removeEventListener('keydown', handleDocumentKeydown);
      }

      const handleDocumentKeydown = (event) => {
        if (event.key === 'Escape') {
          closeModal();
        }
      };

      document.querySelectorAll('.btn-gen').forEach((btn) => {
        btn.addEventListener('click', async () => {
          lastTriggerButton = btn;
          const type = btn.getAttribute('data-type');
          try {
            const response = await postJSON("{% url 'api_generate_activity' %}", {
              assignment_id: assignmentId,
              activity_type: type,
            });
            openModal(response.activity.title || 'Generated', response.clipboard || '');
          } catch (error) {
            openModal('Error', 'Could not generate activity.');
          }
        });
      });

      if (closeButton) {
        closeButton.addEventListener('click', closeModal);
      }

      if (modalDialog) {
        modalDialog.addEventListener('click', (event) => {
          event.stopPropagation();
        });
      }

      if (modalOverlay) {
        modalOverlay.addEventListener('click', (event) => {
          if (event.target === event.currentTarget) {
            closeModal();
          }
        });
      }

      function announceCopySuccess() {
        if (!copyButton) {
          return;
        }
        if (copyResetTimer) {
          window.clearTimeout(copyResetTimer);
        }
        copyButton.disabled = true;
        copyButton.textContent = 'Copied!';
        copyResetTimer = window.setTimeout(() => {
          copyButton.disabled = false;
          copyButton.textContent = 'Copy to Clipboard';
          copyResetTimer = null;
        }, 1600);
      }

      if (copyButton && modalTextarea) {
        copyButton.addEventListener('click', async () => {
          modalTextarea.select();
          modalTextarea.setSelectionRange(0, modalTextarea.value.length);
          try {
            await navigator.clipboard.writeText(modalTextarea.value);
            announceCopySuccess();
          } catch (err) {
            const legacyCopied = document.execCommand('copy');
            if (legacyCopied !== false) {
              announceCopySuccess();
            }
          }
        });
      }
    })();
  </script>
{% include 'messages.html' %}
</body>
</html>
